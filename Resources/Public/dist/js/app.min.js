function streamChatAnswer(){const e=document.getElementById("ai-search-question").value.trim(),t=document.getElementById("aisearch-url-hash")?document.getElementById("aisearch-url-hash").value:"",n=document.getElementById("aisearch-api-host")?document.getElementById("aisearch-api-host").value:"",r=document.getElementById("aisearch-prompt-template")?document.getElementById("aisearch-prompt-template").value:"aaa_default",a=!!document.getElementById("aisearch-list-all-sources")&&"1"===document.getElementById("aisearch-list-all-sources").value;if(""===e||""===t||""===n||""===r)return void console.error(":: > AI-Search: one or more of the required parameters question, url_hash, api_host or prompt_template is empty!");const o=n+"/api/chat-json",s=document.getElementById("answer"),l=document.getElementById("source_documents");if(!s)return void console.error("Answer div not found");const c=new URL(window.location);c.searchParams.set("q",e),window.history.replaceState({},"",c);const i=new FormData;i.append("question",e),i.append("clear_chat_history",1),i.append("llm_type","fast"),i.append("hash",t||""),i.append("streaming",!0),i.append("personality",r),s.innerHTML="",l&&(l.innerHTML=""),toggleLoading(!0),toggleStreamStartHidden(!0),toggleStreamFinishHidden(!0);const d=window.markdownit();let m="",u=0,g=0,h=!1,p=null,f=!1,y=!1;const E=(e,t)=>{const n=document.getElementById(e);if(!n)return console.error(`Template ${e} not found`),null;const r=n.content.cloneNode(!0);return Object.keys(t).forEach(e=>{r.querySelectorAll(`[data-field="${e}"]`).forEach(n=>{"A"===n.tagName?(n.href=t[e],"url"!==e&&(n.textContent=t[e])):"string"==typeof t[e]?n.innerHTML=t[e]:n.appendChild(t[e])})}),r};fetch(o,{method:"POST",body:i}).then(e=>{if(!e.body)throw new Error("No response body for streaming");const t=e.body.getReader(),n=new TextDecoder;let r="";document.querySelector(".rms_ai_search_container .result-container");const o=e=>{switch(e.type){case"metadata":console.log("Metadata:",e);break;case"token":m+=e.content||"",(()=>{if(h)return;h=!0;const e=t=>{t-g>20&&u<m.length&&(u=Math.min(u+2,m.length),s.innerHTML=d.render(m.substring(0,u)),g=t),!f&&u<m.length?p=requestAnimationFrame(e):h=!1};p=requestAnimationFrame(e)})();break;case"complete":{y=e.answer_provided||!1,f=!0;let t=(e.answer_html||d.render(m)).replace(/ZZ_NO_ANSWER_ZZ/g,"").replace(/<div class="rms-chatbot-sources">[\s\S]*?<\/div>/g,"").replace(/<ul class="rms-chatbot-src-links">[\s\S]*?<\/ul>/g,"");const n=(e=>{if(!Array.isArray(e)||0===e.length)return null;let t;a||(t=new Set);let n=!1;const r=[],o=[];e.forEach(e=>{const a=e.metadata||{};let s=(e.content||"").replace(/#[Ss]eitentitel:.*?[Ss]eiteninhalt:.*?\n/gs,"\n"),l=stripTagsExcept(d.render(removeTableFormatting(s)),["strong","/strong","b","/b"]);l=fixOrphanedListItems(l),l=l.replace(/^#+ /gm,""),""!==l.trim()&&o.push({meta:a,plainContent:l});let c=a.title||a.url||"";if(c&&""!==c.trim()&&"null"!==c||(c=a.url||""),!(!c||t&&t.has(c)))if(t&&t.add(c),a.url){let e=l.length>0?`${l.substring(0,1e3)}${l.length>1e3?"...":""}`:"";const t=e.indexOf(c);-1!==t&&(e=e.slice(0,t)+e.slice(t+c.length));const n=E("template-result-item",{url:a.url,snippet:e});if(n){const e=n.querySelector(".result-item-link");e&&(e.textContent=c),r.push(n)}}else n||(n=!0)});const s=document.querySelector(".rms_ai_search_container .source-documents-container");if(s&&0===o.length&&s.classList.add("hidden"),0===r.length)return null;const l=E("template-source-documents-container",{});if(!l)return null;const c=l.querySelector('[data-field="items"]');return c&&r.forEach(e=>c.appendChild(e)),l})(e.source_documents);l&&y&&(l.innerHTML="",n&&l.appendChild(n)),s.innerHTML=t.trim(),p&&cancelAnimationFrame(p),toggleLoading(!1),y&&toggleStreamFinishHidden(!1);const r=document.getElementById("ai-search-question");r&&(r.focus(),r.select()),console.log("Chat stream complete",e);break}case"error":{const t=E("template-error-message",{message:`Error: ${e.message||"unknown"}`});s.innerHTML="",t&&s.appendChild(t),f=!0,p&&cancelAnimationFrame(p),toggleLoading(!1);break}}},c=()=>{t.read().then(({done:e,value:t})=>{if(e)return f=!0,p&&cancelAnimationFrame(p),void toggleLoading(!1);r+=n.decode(t,{stream:!0});const a=r.split("\n\n");r=a.pop(),a.forEach(e=>{const t=extractJSON(e);if(t)try{o(JSON.parse(t))}catch(e){console.error("Error parsing JSON from stream:",e,t)}}),c()}).catch(e=>{console.error("Stream read error:",e),toggleLoading(!1)})};c(),toggleStreamStartHidden(!1)}).catch(e=>{console.error("Error:",e);const t=E("template-error-message",{message:`!! Error: ${e.message}`});s.innerHTML="",t&&s.appendChild(t),toggleLoading(!1)})}const removeTableFormatting=e=>e.replace(/^\s*\|\s*(.*?)\s*\|\s*(.*?)\s*\|\s*(.*?)\s*\|?\s*$/gm,"$1 $2 $3"),stripTagsExcept=(e,t)=>e.replace(/<\/?([^>]+)>/g,(e,n)=>t.includes(n.toLowerCase())?e:""),toggleLoading=e=>{const t=document.getElementById("loading-indicator");t&&t.classList.toggle("hidden",!e)},toggleStreamStartHidden=e=>{document.querySelectorAll(".hidden_until_stream_starts").forEach(t=>t.classList.toggle("hidden",e))},toggleStreamFinishHidden=e=>{document.querySelectorAll(".hidden_until_stream_finish").forEach(t=>t.classList.toggle("hidden",e))},extractJSON=e=>{const t=e.trim();if(t.startsWith("data: "))return t.substring(6);if(t.startsWith("{"))return t;const n=t.indexOf("{");return-1!==n?t.substring(n):null},fixOrphanedListItems=e=>{const t=document.createElement("div");t.innerHTML=e;const n=Array.from(t.querySelectorAll("li")),r=new Set;return n.forEach(e=>{if(r.has(e))return;const t=e.parentElement;if(t&&"UL"!==t.tagName&&"OL"!==t.tagName){const n=[];let a=e;for(;a&&"LI"===a.tagName;)n.push(a),r.add(a),a=a.nextElementSibling;const o=document.createElement("ul");t.insertBefore(o,e),n.forEach(e=>{o.appendChild(e)})}}),t.innerHTML};document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("ai-search-question"),t=document.getElementById("search-form-submit-btn");e&&""!==e.value.trim()&&(console.log(" ========= Document loaded, checking question input..."+e.value,t),t&&streamChatAnswer()),t&&t.addEventListener("click",e=>{e.preventDefault(),streamChatAnswer()});let n=!1;"1"===(document.getElementById("aisearch-autofocus-search-field")?document.getElementById("aisearch-autofocus-search-field").value:"0")&&(n=!0),e&&n&&(e.focus(),e.select())});