const removeTableFormatting=e=>e.replace(/^\s*\|\s*(.*?)\s*\|\s*(.*?)\s*\|\s*(.*?)\s*\|?\s*$/gm,"$1 $2 $3"),stripTagsExcept=(e,t)=>e.replace(/<\/?([^>]+)>/g,(e,n)=>t.includes(n.toLowerCase())?e:""),toggleLoading=e=>{const t=document.getElementById("loading-indicator");t&&t.classList.toggle("hidden",!e)},toggleStreamStartHidden=e=>{document.querySelectorAll(".hidden_until_stream_starts").forEach(t=>t.classList.toggle("hidden",e))},toggleStreamFinishHidden=e=>{document.querySelectorAll(".hidden_until_stream_finish").forEach(t=>t.classList.toggle("hidden",e))},extractJSON=e=>{const t=e.trim();if(t.startsWith("data: "))return t.substring(6);if(t.startsWith("{"))return t;const n=t.indexOf("{");return-1!==n?t.substring(n):null},fixOrphanedListItems=e=>{const t=document.createElement("div");t.innerHTML=e;const n=Array.from(t.querySelectorAll("li")),r=new Set;return n.forEach(e=>{if(r.has(e))return;const t=e.parentElement;if(t&&"UL"!==t.tagName&&"OL"!==t.tagName){const n=[];let o=e;for(;o&&"LI"===o.tagName;)n.push(o),r.add(o),o=o.nextElementSibling;const a=document.createElement("ul");t.insertBefore(a,e),n.forEach(e=>{a.appendChild(e)})}}),t.innerHTML};function streamChatAnswer(e,t,n,r,o){const a=n+"/api/chat-json",s=document.getElementById("answer"),i=document.getElementById("source_documents"),c=new URL(window.location);if(c.searchParams.set("q",e),window.history.replaceState({},"",c),!s)return void console.error("Answer div not found");const l=new FormData;l.append("question",e),l.append("clear_chat_history",1),l.append("llm_type","fast"),l.append("hash",t||""),l.append("streaming",!0),l.append("personality",r),s.innerHTML="",i&&(i.innerHTML=""),toggleLoading(!0),toggleStreamStartHidden(!0),toggleStreamFinishHidden(!0);const d=window.markdownit();let m="",g=0,u=0,h=!1,p=null,f=!1,S=!1;const E=(e,t)=>{const n=document.getElementById(e);if(!n)return console.error(`Template ${e} not found`),null;const r=n.content.cloneNode(!0);return Object.keys(t).forEach(e=>{r.querySelectorAll(`[data-field="${e}"]`).forEach(n=>{"A"===n.tagName?(n.href=t[e],"url"!==e&&(n.textContent=t[e])):"string"==typeof t[e]?n.innerHTML=t[e]:n.appendChild(t[e])})}),r};fetch(a,{method:"POST",body:l}).then(e=>{if(!e.body)throw new Error("No response body for streaming");const t=e.body.getReader(),n=new TextDecoder;let r="";document.querySelector(".rms_ai_search_container .result-container");const a=e=>{switch(e.type){case"metadata":console.log("Metadata:",e);break;case"token":m+=e.content||"",(()=>{if(h)return;h=!0;const e=t=>{t-u>20&&g<m.length&&(g=Math.min(g+2,m.length),s.innerHTML=d.render(m.substring(0,g)),u=t),!f&&g<m.length?p=requestAnimationFrame(e):h=!1};p=requestAnimationFrame(e)})();break;case"complete":{S=e.answer_provided||!1,f=!0;let t=(e.answer_html||d.render(m)).replace(/ZZ_NO_ANSWER_ZZ/g,"").replace(/<div class="rms-chatbot-sources">[\s\S]*?<\/div>/g,"").replace(/<ul class="rms-chatbot-src-links">[\s\S]*?<\/ul>/g,"");const n=(e=>{if(!Array.isArray(e)||0===e.length)return null;let t;o||(t=new Set);let n=!1;const r=[],a=[];e.forEach(e=>{const o=e.metadata||{};let s=(e.content||"").replace(/#[Ss]eitentitel:.*?[Ss]eiteninhalt:.*?\n/gs,"\n"),i=stripTagsExcept(d.render(removeTableFormatting(s)),["strong","/strong","b","/b"]);i=fixOrphanedListItems(i),i=i.replace(/^#+ /gm,""),""!==i.trim()&&a.push({meta:o,plainContent:i});let c=o.title||o.url||"";if(c&&""!==c.trim()&&"null"!==c||(c=o.url||""),!(!c||t&&t.has(c)))if(t&&t.add(c),o.url){let e=i.length>0?`${i.substring(0,1e3)}${i.length>1e3?"...":""}`:"";const t=e.indexOf(c);-1!==t&&(e=e.slice(0,t)+e.slice(t+c.length));const n=E("template-result-item",{url:o.url,snippet:e});if(n){const e=n.querySelector(".result-item-link");e&&(e.textContent=c),r.push(n)}}else n||(n=!0)});const s=document.querySelector(".rms_ai_search_container .source-documents-container");if(s&&0===a.length&&s.classList.add("hidden"),0===r.length)return null;const i=E("template-source-documents-container",{});if(!i)return null;const c=i.querySelector('[data-field="items"]');return c&&r.forEach(e=>c.appendChild(e)),i})(e.source_documents);i&&S&&(i.innerHTML="",n&&i.appendChild(n)),s.innerHTML=t.trim(),p&&cancelAnimationFrame(p),toggleLoading(!1),S&&toggleStreamFinishHidden(!1);const r=document.getElementById("ai-search-question");r&&(r.focus(),r.select()),console.log("Chat stream complete",e);break}case"error":{const t=E("template-error-message",{message:`Error: ${e.message||"unknown"}`});s.innerHTML="",t&&s.appendChild(t),f=!0,p&&cancelAnimationFrame(p),toggleLoading(!1);break}}},c=()=>{t.read().then(({done:e,value:t})=>{if(e)return f=!0,p&&cancelAnimationFrame(p),void toggleLoading(!1);r+=n.decode(t,{stream:!0});const o=r.split("\n\n");r=o.pop(),o.forEach(e=>{const t=extractJSON(e);if(t)try{a(JSON.parse(t))}catch(e){console.error("Error parsing JSON from stream:",e,t)}}),c()}).catch(e=>{console.error("Stream read error:",e),toggleLoading(!1)})};c(),toggleStreamStartHidden(!1)}).catch(e=>{console.error("Error:",e);const t=E("template-error-message",{message:`!! Error: ${e.message}`});s.innerHTML="",t&&s.appendChild(t),toggleLoading(!1)})}document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("ai-search-question");if(e&&""!==e.value.trim()){console.log(" ========= Document loaded, checking question input..."+e.value);const t=document.getElementById("search-form-submit-btn");t&&t.dispatchEvent(new Event("click"))}e&&(e.focus(),e.select())});